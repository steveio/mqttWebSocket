<!DOCTYPE html>
<html>
  <head>
    <title>Simple Gauge Visualization</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta charset='utf-8' />
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>
    text {
      font-family: "Verdana", sans-serif;
    }
    .chart {
      float: left;
      max-width: 500px;
    }
    .filter-green{
        filter: invert(48%) sepia(79%) saturate(2476%) hue-rotate(86deg) brightness(118%) contrast(119%);
    }

    </style>
  </head>
  <body>

    <div>
      <h4>Last Weather Station Sample: <span id="datetime"></span></h4>
    </div>

    <div style="float: left;">
    <div class="chart" id="chartTempC"></div>
    <div class="chart" id="chartP"></div>
    <div class="chart" id="chartH"></div>
    <div class="chart" id="chartLDR"></div>
    </div>


    <script src="wsRadialGauge.js"></script>
    <script>


    var gaugeTempC = gaugeChart()
      .width(460)
      .height(270)
      .innerRadius(50)
      .outerRadius(80)
      .dataDomain([0,20,40])
      .imgUrl(["thermometer-25.svg","degrees-celcius.svg"]);

    /*
      Barometer Additional Use Cases:
        - plot symbols / text for stormy|rain|change|fair|dry
        - marker lines for low / high Pressure
        - display current + previous (average) pressure
    */
    var gaugeP = gaugeChart()
      .width(460)
      .height(270)
      .innerRadius(50)
      .outerRadius(80)
      .ticks(15)
      .dataDomain([980,1010,1050])
      .imgUrl([]);

    var gaugeH = gaugeChart()
      .width(460)
      .height(270)
      .innerRadius(50)
      .outerRadius(80)
      .dataDomain([0,50,100])
      .imgUrl(["raindrop.svg"]);


    var gaugeLDR = gaugeChart()
      .width(460)
      .height(270)
      .ticks(15)
      .innerRadius(50)
      .outerRadius(80)
      .dataDomain([0,50,100])
      .imgUrl([]);


    d3.select("#chartTempC").datum([0]).call(gaugeTempC);
    d3.select("#chartP").datum([0]).call(gaugeP);
    d3.select("#chartH").datum([0]).call(gaugeH);
    d3.select("#chartLDR").datum([0]).call(gaugeLDR);


    //setLDRIcon(gaugeLDR,55);
    function resize() {
      var gWidth = Math.min(d3.select("#chartTempC").node().offsetWidth, 400);
      gaugeTempC.width(gWidth).innerRadius(gWidth / 4).outerRadius((gWidth / 4) + 40);
      d3.select("#chartTempC").call(gaugeTempC);

      var gWidth = Math.min(d3.select("#chartP").node().offsetWidth, 400);
      gaugeP.width(gWidth).innerRadius(124).outerRadius((150));
      d3.select("#chartP").call(gaugeP);

      var gWidth = Math.min(d3.select("#chartH").node().offsetWidth, 400);
      gaugeH.width(gWidth).innerRadius(gWidth / 4).outerRadius((gWidth / 4) + 40);
      d3.select("#chartH").call(gaugeH);

      var gWidth = Math.min(d3.select("#chartLDR").node().offsetWidth, 400);
      gaugeLDR.width(gWidth).innerRadius(164).outerRadius((1140) + 40);
      d3.select("#chartLDR").call(gaugeLDR);
    }

    resize();
    window.addEventListener("resize", resize);

    var dataArr = [];
    // setup WebSocket
    var ws = new WebSocket('ws://127.0.0.1:8080',[]);

    function setupWebSocket()
    {
      ws.onopen = function () {
        console.log('WebSocket Open');
      };

      ws.onerror = function (error) {
        console.log('WebSocket Error ' + error);
      };

      ws.onmessage = function (e) {
        var rawData = e.data;
        if(rawData.trim().length > 1)
        {
          var jsonObj = JSON.parse(rawData);
          //dataArr.push(jsonObj);
          processData(jsonObj);
        }
      };

    }

    function processData(jsonObj) {
        console.log(jsonObj[0]['tempC']);

        jsonObj[0]['p'] = jsonObj[0]['p'] / 100;
        jsonObj[0]['LDR'] = 1024 - jsonObj[0]['LDR'];
        jsonObj[0]['LDR'] = jsonObj[0]['LDR'] / 1024 * 100;

        d3.select("#chartTempC").datum([jsonObj[0]['tempC']]).call(gaugeTempC);
        d3.select("#chartH").datum([jsonObj[0]['h']]).call(gaugeH);
        setLDR(gaugeLDR,jsonObj[0]['LDR']);
        // @todo - compute previous (avg) level
        setBarometer(gaugeP,jsonObj[0]['p'],1040);

        setLastSampleDate(jsonObj[0]['ts']);

    }

    document.addEventListener("DOMContentLoaded", function() {
        setupWebSocket();

    });

    function setLastSampleDate(ts)
    {
      var d = new Date(ts * 1000);
      var hours = ("0" + d.getHours()).slice(-2);
      var dateStr = d.getDate() + '/' + (d.getMonth()+1) + '/' + d.getFullYear() + " " + hours+":"+d.getMinutes()+":"+d.getSeconds();
      console.log(dateStr);
      document.getElementById("datetime").innerHTML = dateStr;
    }

    function setLDR(gaugeLDR,level)
    {
      if (level > 85)
      {
        gaugeLDR = gaugeLDR.imgUrl(["sun.svg"]);
      } else if (level > 50) {
        gaugeLDR = gaugeLDR.imgUrl(["cloud-sun.svg"]);
      } else {
        gaugeLDR = gaugeLDR.imgUrl(["moon-stars.svg"]);
      }

      d3.select("#chartLDR").selectAll("svg").remove();
      d3.select("#chartLDR").datum([level]).call(gaugeLDR);

    }

    function setBarometer(gaugeP,level, prevLevel)
    {
      var highPressure = 1022;
      var lowPressure = 1009;
      var margin = 20;
      var diff = level - prevLevel;
      if (Math.sign(diff) == -1)
      {
        Math.abs(diff);
      }

      if (level >= highPressure)
      {
        if (level <= prevLevel)
        {
          if (diff <= margin) // slowly falling: continued fair
          {
            gaugeP = gaugeP.imgUrl(["sun.svg"]);
          } else { // falling rapidly: cloudy/warmer
            gaugeP = gaugeP.imgUrl(["cloud-sun.svg"]);
          }
        } else { // rising or steady pressure: continued fair
            gaugeP = gaugeP.imgUrl(["sun.svg"]);
        }
      } else if (level <= lowPressure) {

        if (level <= prevLevel)
        {
          if (diff <= margin) // slowly falling: rain
          {
            gaugeP = gaugeP.imgUrl(["umbrella-drizzle.svg"]);
          } else { // falling rapidly: stormy
            gaugeP = gaugeP.imgUrl(["cloud-drizzle-lightning.svg"]);
          }
        } else { // rising or steady pressure: clearing and/or cooler
            gaugeP = gaugeP.imgUrl(["cloud-sun-2.svg"]);
        }

      } else { // normal pressure
        if (level <= prevLevel)
        {
          if (diff <= margin) // slowly falling: continued fair
          {
            gaugeP = gaugeP.imgUrl(["cloud-sun.svg"]);
          } else { // falling rapidly: rain or snow if cold enough
            gaugeP = gaugeP.imgUrl(["cloud-rain-2.svg"]);
          }
        } else { // rising or steady pressure: present continues
            gaugeP = gaugeP.imgUrl(["cloud-sun.svg"]);
        }
      }

      d3.select("#chartP").selectAll("svg").remove();
      d3.select("#chartP").datum([level,prevLevel]).call(gaugeP);

    }


    function randNumberBounds(min, max) {
      min = Math.ceil(min);
      max = Math.floor(max);
      return Math.floor(Math.random() * (max - min)) + min;
    }
    </script>
</body>
</html>
